<div class="container orders-funnel">
  <%= render 'shared/order_breadcrumb' %>
  <br>
  <h1>REVISIÓN DEL PEDIDO</h1>

  <div class="order-review">
    <div class="order-summary">
      <% total_quantity = 0 %>
      <% @current_cart.line_items.reverse.each do |line_item| %>
        <div class="cart-product d-flex align-items-center">
          <%= cl_image_tag line_item.photo_key, height: 120, width: 120, crop: :fill %>
          <div class="grow-1">
            <p><b><%= line_item.product_variation.product.name %></b></p>
            <% if line_item.product_variation.color != '' %>
              <p>Color: <%= line_item.product_variation.color %></p>
            <% end %>
            <p>Tamaño: <%= line_item.product_variation.size %></p>
            <p>$<%= line_item.product_variation.price %></p>
            <p>Cantidad: <%= line_item.quantity %></p>
          </div>
          <% total_quantity += line_item.quantity %>
        </div>
      <% end %>
    </div>
    <div class="order-detail">
      <div class="position-relative">
        <% if user_signed_in? %>
<!--           If user want to modify its profile while ordering, we need to add a flag parameter 'order_edit' in URL
          to differenciate it from users who wants to modify their profile from dashboard -->
          <%= link_to edit_user_registration_path(order_edit: true) do %>
            <i class="fas fa-pen"></i>
          <% end %>
        <% else %>
          <%= link_to edit_fake_user_path(@user) do %>
            <i class="fas fa-pen"></i>
          <% end %>
        <% end %>
        <h2>Información de contacto</h2>
        <p><%= @user.first_name %> <%= @user.last_name %></p>
        <p><%= @user.email %></p>
        <p><%= @user.phone %></p>
      </div>
      <div class="position-relative">
        <h2>Dirección</h2>
        <% if user_signed_in? %>
<!--           If user want to modify its address while ordering, we need to add a flag parameter 'order_edit' in URL
          to differenciate it from users who wants to modify their address from dashboard -->
          <%= link_to edit_user_address_path(@user, @address, order_edit: true) do %>
            <i class="fas fa-pen"></i>
          <% end %>
        <% else %>
          <%= link_to edit_fake_user_address_path(@user, @address, order_edit: true) do %>
            <i class="fas fa-pen"></i>
          <% end %>
        <% end %>
        <p><%= @address.street %></p>
        <p><%= @address.flat_number %></p>
        <p><%= @address.district %></p>
        <p><%= @address.detail %></p>
        <p><%= @address.city %></p>
        <div id="show-address-map"
         style="width: 100%; height: 200px;"
         data-lat="<%= @address.latitude %>"
         data-lng="<%= @address.longitude %>"
         data-mapbox-api-key="<%= ENV['MAPBOX_API_KEY'] %>"></div>
      </div>
    </div>
  </div>
  <div class="order-review-footer">
    <div class="my-3">
      <p><%= pluralize(total_quantity, 'producto') %></p>
      <p>Sub Total: $<%= @current_cart.sub_total %></p>
       <p>Entrega:
          <% if @current_cart.shipping > 0 %>
            $<%= @current_cart.shipping %>
          <% else %>
            <b>¡Envío gratuito!</b>
          <% end %>
        </p>
      <p>ITBMS (7%): $<%= (@current_cart.itbms) %></p>
      <p><b>TOTAL: $<%= @current_cart.total %></b></p>
    </div>
    <% if user_signed_in? %>
      <%= link_to "CONFIRMAR PEDIDO", user_orders_path, method: :post, class: 'btn btn-yellow w-100' %>
    <% else %>
      <%= link_to "CONFIRMAR PEDIDO", fake_user_orders_path, method: :post, class: 'btn btn-yellow w-100' %>
    <% end %>
    <div class="order-review-footer-bottom mt-3">
      <p class='text-center'>Todos los pagos se hacen contra entrega. Gracias por preferirnos.</p>
      <div class="payment-logos">
        <%= cl_image_tag 'https://res.cloudinary.com/blueforest/image/upload/v1591088125/payments-logo/1-visa_unvmtw.png', width: 50, crop: :fill, style: 'background-color: white, padding: 10px;' %>
        <%= cl_image_tag 'https://res.cloudinary.com/blueforest/image/upload/v1591088122/payments-logo/2-mastercard_scrnh5.png', width: 50, crop: :fill %>
        <%= cl_image_tag 'https://res.cloudinary.com/blueforest/image/upload/v1591088123/payments-logo/3-clave_dzrpsj.png', width: 50, crop: :fill %>
        <%= cl_image_tag 'https://res.cloudinary.com/blueforest/image/upload/v1591088122/payments-logo/4-yappy_mzep5g.png', width: 50, crop: :fill %>
        <%= cl_image_tag 'https://res.cloudinary.com/blueforest/image/upload/v1591088122/payments-logo/5-ach_ddyell.png', width: 50, crop: :fill %>
        <%= cl_image_tag 'https://res.cloudinary.com/blueforest/image/upload/v1591088122/payments-logo/6-cash_fa0zx5.png', width: 50, crop: :fill %>
      </div>
    </div>
  </div>
</div>
